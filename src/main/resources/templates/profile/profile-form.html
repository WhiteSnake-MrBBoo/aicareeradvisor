<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>프로필 생성 · AI Career Advisor</title>

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            crossorigin="anonymous">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .profile-layout {
            min-height: 100vh;
            padding-top: 40px;
            padding-bottom: 40px;
        }

        .profile-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.05);
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .section-subtext {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
<div class="container profile-layout">

    <!-- 상단 헤더: 현재 사용자 정보 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">😊 취업상담 프로필 생성</h2>
            <p class="text-muted mb-0">
                진로 분석과 추천을 위한 기본 프로필 정보를 입력합니다.
            </p>
        </div>
        <div class="text-end">
            <div class="badge bg-primary-subtle text-primary">
                현재 사용자:
                <span th:text="${currentUserName}">홍길동</span>
                (<span th:text="${currentUserGroup}">ADULT</span>)
            </div>
        </div>
    </div>

    <!-- Main 폼 -->
    <form th:action="@{/profile/save}"
          th:object="${profileForm}"
          method="post"

          id="profileForm" > <!--form 시작 지점-->


        <!-- 1. 프로필 기본 정보 (ProfileType) -->
        <!-- 매핑: PrfProfile.profileTitle, PrfProfile.profileType(ProfileType) -->
        <div class="profile-card">
            <div class="section-title">🥸 1.취업상담 프로필 기본 정보</div>

            <div class="mb-3">
                <label class="form-label" for="profileTitle">프로필 제목</label>
                <input type="text"
                       class="form-control"
                       id="profileTitle"
                       th:field="*{profileTitle}"
                       placeholder="예) 홍길동 - 2025 취업 준비 프로필"
                       required>
                <div class="form-text section-subtext">
                    예) “홍길동 - 고3 진학/진로 프로필”, “홍길동 - 경력 전환(개발자) 프로필” 등
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">취업진로 상담 연령 : (ProfileType)</label>
                <select class="form-select"
                        th:field="*{profileType}">
                    <!-- ProfileType Enum과 1:1 매핑 -->
                    <option th:value="ADULT_JOBSEEKER">성인 구직자</option>
                    <option th:value="HIGHSCHOOL">고등학생</option>
                    <option th:value="MIDDLESCHOOL">중학생</option>
                    <option th:value="ELEMENTARY">초등학생</option>
                    <option th:value="UNIVERSITY">대학생</option>
                </select>
                <div class="form-text section-subtext">
                    사용자군(UserGroup)에 따라 기본값이 세팅되며, 필요 시 여기서 수정 가능합니다.
                </div>
            </div>
        </div>

        <!-- 2. 희망 커리어 방향 -->
        <!-- 매핑(현재): careerOptionCode1~3 (추후 TargetLevel 추가 예정) -->
        <div class="profile-card">
            <div class="section-title">2. 희망 취업진로 커리어 방향</div>

            <p class="text-muted section-subtext">
                현재 기준으로 가장 가고 싶은 직무/직업을 우선순위대로 적어 주세요.
                <br>※ 추후 Work24 직업코드 및 TargetLevel(ENTRY/JUNIOR/MID/SENIOR)과 연동 예정
                <!-- TODO: TargetLevel Enum(TargetLevel)을 각 진로 후보와 매칭하는 UI 추가 자리 -->
            </p>

            <!-- 1순위 -->
            <div class="mb-3">
                <label class="form-label">1순위 진로 후보</label>
                <input type="text"
                       class="form-control"
                       th:field="*{careerOptionCode1}"
                       placeholder="예) 백엔드 개발자, 공공기관 일반행정, 임상심리사 등">
            </div>

            <!-- 2순위 -->
            <div class="mb-3">
                <label class="form-label">2순위 진로 후보</label>
                <input type="text"
                       class="form-control"
                       th:field="*{careerOptionCode2}"
                       placeholder=" 2순위 진로 희망 분야 입력해주세요">

            </div>

            <!-- 3순위 -->
            <div class="mb-3">
                <label class="form-label">3순위 진로 후보</label>
                <input type="text"
                       class="form-control"
                       th:field="*{careerOptionCode3}"
                       placeholder=" 3 순위 진로 희망 분야 입력해주세요">
            </div>
        </div>

        <!-- 3. 보유 스킬 -->
        <!-- 매핑: selectedSkillCodes(List<String>) -> PrfProfileSkill(skillCd)
             TODO: 향후 SkillLevel(Enum SkillLevel) 추가 시, 각 스킬 옆에 숙련도 드롭다운 추가 -->
        <div class="profile-card">
            <div class="section-title">3.개별 역량 보유 스킬</div>

            <p class="text-muted section-subtext">
                현재 본인이 보유하고 있다고 생각하는 기술/역량을 모두 선택해 주세요.
                <br>※ 향후 각 스킬별 숙련도(SkillLevel: BASIC/INTERMEDIATE/ADVANCED) 입력 기능 추가 예정
            </p>

            <div class="row">
                <div class="col-md-6"
                     th:each="skill : ${skillList}">
                    <div class="form-check mb-1">
                        <input class="form-check-input"
                               type="checkbox"
                               th:field="*{selectedSkillCodes}"
                               th:value="${skill.skillCd}"
                               th:id="'skill_' + ${skill.skillCd}">
                        <label class="form-check-label"
                               th:for="'skill_' + ${skill.skillCd}">
                            <span th:text="${skill.skillName}">JAVA</span>
                        </label>
                        <!-- TODO: 여기 옆에 SkillLevel 드롭다운 자리 확보 가능 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 직업 가치관 Top3 (버튼형 카드 UI) -->
        <!-- 매핑: selectedValueCode1~3 -> PrfProfileValue(valueCd, orderIndex) -->
        <div class="profile-card">
            <div class="section-title">4. 직업 선택시 가치관 Top3</div>

            <p class="text-muted section-subtext">
                직업 선택 시 가장 중요하게 생각하는 가치를 3가지까지 선택해 주세요.
            </p>

            <div class="row g-2" id="valueChoiceContainer">
                <div class="col-6 col-md-4" th:each="value : ${valueList}">
                    <button type="button"
                            class="btn w-100 text-start border value-choice-btn"
                            th:data-value-code="${value.valueCd}">
                        <!-- 아이콘: 코드에 따라 단순 매핑 (예시) -->
                        <i class="bi bi-graph-up-arrow me-2"
                           th:if="${value.valueCd == 'GROWTH'}"></i>
                        <i class="bi bi-emoji-smile me-2"
                           th:if="${value.valueCd == 'WORK_LIFE'}"></i>
                        <i class="bi bi-cash-coin me-2"
                           th:if="${value.valueCd == 'HIGH_SALARY'}"></i>
                        <i class="bi bi-people me-2"
                           th:if="${value.valueCd == 'TEAM_CULTURE'}"></i>
                        <i class="bi bi-shield-check me-2"
                           th:if="${value.valueCd == 'JOB_SECURITY'}"></i>
                        <i class="bi bi-stars me-2"
                           th:if="${value.valueCd == 'AUTONOMY'}"></i>

                        <!-- 기본 텍스트 -->
                        <span th:text="${value.valueName}">성장 가능성</span>
                    </button>
                </div>
            </div>

            <!-- 실제로 서버로 넘어가는 값 (Top3 순서) -->
            <input type="hidden" th:field="*{selectedValueCode1}" id="valueCode1">
            <input type="hidden" th:field="*{selectedValueCode2}" id="valueCode2">
            <input type="hidden" th:field="*{selectedValueCode3}" id="valueCode3">

            <div class="form-text section-subtext mt-2">
                선택된 값은 1순위, 2순위, 3순위 순서로 저장됩니다. (최대 3개까지 선택 가능)
            </div>
        </div>

        <!-- 5. 선호 근무환경 -->
        <!-- 매핑: selectedWorkEnvCodes(List<String>) -> PrfProfileWorkEnv(envCd)
             Work24 검색조건(근무형태/복지/근무형태 등)과 연결 예정 -->
        <div class="profile-card">
            <div class="section-title">5.직업선택시 선호 근무환경(현실)</div>

            <p class="text-muted section-subtext">
                근무 형태, 조직 문화, 복지 등에서 선호하는 조건을 선택해 주세요.
            </p>

            <div class="row">
                <div class="col-md-6"
                     th:each="env : ${workEnvList}">
                    <div class="form-check mb-1">
                        <input class="form-check-input"
                               type="checkbox"
                               th:field="*{selectedWorkEnvCodes}"
                               th:value="${env.envCd}"
                               th:id="'env_' + ${env.envCd}">
                        <label class="form-check-label"
                               th:for="'env_' + ${env.envCd}">
                            <span th:text="${env.envName}">재택/하이브리드</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. 보유 경험 (ExperienceType) -->
        <!-- 매핑: experienceType(ExperienceType), 경험 상세 필드들 -> ProfileExperience 엔티티 -->
        <div class="profile-card">
            <div class="section-title">6.보유 역량 및 경력</div>

            <p class="text-muted section-subtext">
                현재 진로/취업과 관련된 경험을 추가해 주세요. (인턴, 프로젝트, 교육, 자격증, 대외활동 등)
                <br>※ 지금은 대표적인 몇 개 경험만 입력해도 충분합니다.
            </p>

            <!-- 경험 카드 리스트 영역 -->
            <div id="experienceList" class="mb-3">
                <!-- JS로 카드가 추가될 영역 -->
                <!-- TODO: 다음 단계에서 서버에서 이미 저장된 경험을 불러와 카드로 렌더링할 수 있음 -->
            </div>

            <!-- 경험이 없을 때 안내 -->
            <div id="experienceEmptyHint" class="alert alert-light border d-flex align-items-center">
                <div class="me-2">
                    <i class="bi bi-info-circle"></i>
                </div>
                <div class="small">
                    아직 등록된 경험이 없습니다. 아래 버튼을 눌러 첫 번째 경험을 추가해 보세요.
                </div>
            </div>

            <!-- 경험 추가 버튼 -->
            <div class="d-grid mt-3">
                <button type="button"
                        class="btn btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#experienceModal">
                    <i class="bi bi-plus-lg me-1"></i> 경력 및 역량 추가하기
                </button>
            </div>

            <!-- 중요: 현재 단계에서는 기존 단일 경험 필드는 그대로 둡니다 -->
            <!-- (나중에 다건 경험 저장으로 리팩토링할 때, 이 필드들은 대표 경험/첫 경험 등으로 역할 변경) -->
            <input type="hidden" th:field="*{experienceType}">
            <input type="hidden" th:field="*{experienceTitle}">
            <input type="hidden" th:field="*{experienceOrganization}">
            <input type="hidden" th:field="*{experienceStartDate}">
            <input type="hidden" th:field="*{experienceEndDate}">
            <input type="hidden" th:field="*{experienceDescription}">
            <input type="hidden" th:field="*{experienceOutcome}">
            <input type="hidden" th:field="*{experienceLinkUrl}">
            <!-- TODO: 다음 단계에서 "경험 리스트 JSON"용 hidden 필드를 새로 추가하고, JS로 채워서 보내는 구조로 확장 예정 -->

            <!-- 경험 리스트 JSON (서버로 전송되는 실제 데이터) -->
            <input type="hidden"
                   th:field="*{experienceJson}"
                   id="experienceJsonField">
        </div>


        <!-- 경험 입력 모달 -->
        <div class="modal fade" id="experienceModal" tabindex="-1" aria-labelledby="experienceModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="experienceModalLabel">보유역량 및 경력 추가/수정</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">경력 및 역량 유형 (ExperienceType)</label>
                            <select class="form-select" id="expTypeInput">
                                <option value="">선택하세요</option>
                                <option value="WORK">경력 (정규직/계약/인턴 등)</option>
                                <option value="PROJECT">프로젝트/포트폴리오</option>
                                <option value="EDU">교육/부트캠프/학교</option>
                                <option value="CERT">자격증 취득</option>
                                <option value="ACTIVITY">동아리/대외활동/봉사 등</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">경력 및 역량 제목</label>
                            <input type="text" class="form-control" id="expTitleInput"
                                   placeholder="예) 백엔드 개발자 인턴, 공공기관 단기계약 등">
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">시작일</label>
                                <input type="date" class="form-control" id="expStartDateInput">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">종료일</label>
                                <input type="date" class="form-control" id="expEndDateInput">
                            </div>
                        </div>

                        <div class="mb-3 mt-3">
                            <label class="form-label">기관/회사명</label>
                            <input type="text" class="form-control" id="expOrgInput"
                                   placeholder="예) OOO 주식회사, OOO 고등학교, OOO 부트캠프 등">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">주요 활동 내용</label>
                            <textarea class="form-control" rows="3" id="expDescInput"
                                      placeholder="담당 업무, 수행 역할, 사용 기술 등을 적어 주세요."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">성과/결과</label>
                            <textarea class="form-control" rows="3" id="expOutcomeInput"
                                      placeholder="성과, 숫자로 표현 가능한 결과, 배운 점 등을 적어 주세요."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">관련 링크 (선택)</label>
                            <input type="url" class="form-control" id="expLinkInput"
                                   placeholder="포트폴리오, GitHub, Notion 등 URL">
                        </div>

                        <!-- 편집 시 사용할 인덱스(신규면 -1) -->
                        <input type="hidden" id="expIndexInput" value="-1">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            취소
                        </button>
                        <button type="button" class="btn btn-primary" id="expSaveBtn">
                            저장
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. 진로 고민 -->
        <!-- 매핑: selectedConcernCodes(List<String>) + concernDetailText -> ProfileConcern 엔티티 리스트 -->
        <div class="profile-card">
            <div class="section-title">7. 진로 선택 시 고민되는 부분(진로상담)</div>

            <p class="text-muted section-subtext">
                현재 진로/취업을 고민하면서 특히 부담되거나 막히는 부분이 있다면 선택해 주세요.
                선택된 고민들은 AI 분석 및 향후 진로 상담사시 참고 정보로 활용됩니다.
            </p>

            <div class="row">
                <div class="col-md-6"
                     th:each="concern : ${concernList}">
                    <div class="form-check mb-1">
                        <input class="form-check-input"
                               type="checkbox"
                               th:field="*{selectedConcernCodes}"
                               th:value="${concern.concernCd}"
                               th:id="'concern_' + ${concern.concernCd}">
                        <label class="form-check-label"
                               th:for="'concern_' + ${concern.concernCd}">
                            <span th:text="${concern.concernName}">연봉/안정성</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <label class="form-label">진로 선택시 고민 되는 부분이 있으면 말씀해주세요(선택)</label>
                <textarea class="form-control"
                          rows="3"
                          th:field="*{concernDetailText}"
                          placeholder="예) 나이, 경력 단절, 전공과 다른 직무 선택에 대한 불안 등"></textarea>
            </div>
        </div>

        <!-- 버튼 영역 -->
        <div class="d-flex justify-content-between">
            <a th:href="@{/profile/list}" class="btn btn-outline-secondary">
                목록으로 돌아가기
            </a>
            <button type="submit" class="btn btn-primary">
                프로필 저장
            </button>
        </div>

    </form><!--전체 프로필 저장 form 끝 지점-->
</div>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<script> //6번 보유경험 및 역량 추가 자바 스크립트
    // 간단한 클라이언트 사이드 경험 리스트 관리 (V1)
    // - 다음 단계에서 이 리스트를 hidden 필드(JSON)로 넘겨주고 백엔드에서 List<ProfileExperienceRequest>로 파싱 예정
    let experiences = [];

    function renderExperienceList() {
        const listEl = document.getElementById('experienceList');
        const emptyHintEl = document.getElementById('experienceEmptyHint');

        listEl.innerHTML = '';

        if (experiences.length === 0) {
            emptyHintEl.style.display = 'block';
            return;
        }
        emptyHintEl.style.display = 'none';

        experiences.forEach((exp, idx) => {
            const card = document.createElement('div');
            card.className = 'border rounded p-3 mb-2';

            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-semibold">${exp.title || '(제목 없음)'}</div>
                        <div class="text-muted small">
                            [${exp.type || '-'}] ${exp.organization || ''}
                            · ${exp.startDate || ''} ~ ${exp.endDate || ''}
                        </div>
                        <div class="small mt-1 text-truncate" style="max-width: 520px;">
                            ${exp.description || ''}
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary me-1"
                                onclick="editExperience(${idx})">
                            수정
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                onclick="removeExperience(${idx})">
                            삭제
                        </button>
                    </div>
                </div>
            `;
            listEl.appendChild(card);
        });

        // TODO: 다음 단계에서 experiences 배열을 JSON으로 직렬화하여 hidden 필드에 넣을 예정
        // document.getElementById('experienceJsonField').value = JSON.stringify(experiences);
    }

    function editExperience(idx) {
        const exp = experiences[idx];
        document.getElementById('expTypeInput').value = exp.type || '';
        document.getElementById('expTitleInput').value = exp.title || '';
        document.getElementById('expOrgInput').value = exp.organization || '';
        document.getElementById('expStartDateInput').value = exp.startDate || '';
        document.getElementById('expEndDateInput').value = exp.endDate || '';
        document.getElementById('expDescInput').value = exp.description || '';
        document.getElementById('expOutcomeInput').value = exp.outcome || '';
        document.getElementById('expLinkInput').value = exp.linkUrl || '';
        document.getElementById('expIndexInput').value = idx;

        const modal = bootstrap.Modal.getOrCreateInstance(
            document.getElementById('experienceModal'));
        modal.show();
    }

    function removeExperience(idx) {
        experiences.splice(idx, 1);
        renderExperienceList();
    }

    //경력 및 포트폴리오 다중 선택 save 버튼 modal 창
    document.getElementById('expSaveBtn')?.addEventListener('click', function () {
        const type = document.getElementById('expTypeInput').value;
        const title = document.getElementById('expTitleInput').value;
        const organization = document.getElementById('expOrgInput').value;
        const startDate = document.getElementById('expStartDateInput').value;
        const endDate = document.getElementById('expEndDateInput').value;
        const description = document.getElementById('expDescInput').value;
        const outcome = document.getElementById('expOutcomeInput').value;
        const linkUrl = document.getElementById('expLinkInput').value;
        const index = parseInt(document.getElementById('expIndexInput').value, 10);

        const expObj = {type, title, organization, startDate, endDate, description, outcome, linkUrl};

        if (index >= 0) {
            experiences[index] = expObj;
        } else {
            experiences.push(expObj);
        }

        // 모달 닫기
        const modal = bootstrap.Modal.getOrCreateInstance(
            document.getElementById('experienceModal'));
        modal.hide();

        // 폼 입력 초기화
        document.getElementById('expTypeInput').value = '';
        document.getElementById('expTitleInput').value = '';
        document.getElementById('expOrgInput').value = '';
        document.getElementById('expStartDateInput').value = '';
        document.getElementById('expEndDateInput').value = '';
        document.getElementById('expDescInput').value = '';
        document.getElementById('expOutcomeInput').value = '';
        document.getElementById('expLinkInput').value = '';
        document.getElementById('expIndexInput').value = '-1';

        renderExperienceList();
    });

    // 페이지 처음 로드 시 리스트 렌더 (현재는 빈 배열 기준)
    document.addEventListener('DOMContentLoaded', renderExperienceList);
</script>
<script>
    // 04. 직업 가치관 Top3 선택 로직
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('.value-choice-btn');
        const v1 = document.getElementById('valueCode1');
        const v2 = document.getElementById('valueCode2');
        const v3 = document.getElementById('valueCode3');

        function getSelectedList() {
            const list = [];
            if (v1.value) list.push(v1.value);
            if (v2.value) list.push(v2.value);
            if (v3.value) list.push(v3.value);
            return list;
        }

        function setSelectedList(list) {
            v1.value = list[0] || '';
            v2.value = list[1] || '';
            v3.value = list[2] || '';
        }

        function refreshButtonUI() {
            const selected = getSelectedList();
            buttons.forEach(btn => {
                const code = btn.getAttribute('data-value-code');
                if (selected.includes(code)) {
                    btn.classList.add('btn-primary', 'text-white');
                    btn.classList.remove('btn-outline-secondary');
                } else {
                    btn.classList.remove('btn-primary', 'text-white');
                    btn.classList.add('btn-outline-secondary');
                }
            });
        }

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const code = btn.getAttribute('data-value-code');
                let selected = getSelectedList();

                if (selected.includes(code)) {
                    // 이미 선택된 값이면 해제
                    selected = selected.filter(c => c !== code);
                } else {
                    // 새로 선택
                    if (selected.length < 3) {
                        selected.push(code);
                    } else {
                        // 3개를 초과하면 맨 앞을 밀어내고 뒤에 추가(선택 정책은 필요에 따라 변경 가능)
                        selected.shift();
                        selected.push(code);
                    }
                }
                setSelectedList(selected);
                refreshButtonUI();
            });
        });

        // 초기 로딩 시 (서버에서 값이 채워져 있을 수 있으므로) UI 동기화
        refreshButtonUI();
    });

        // ... 위쪽 experiences 배열, renderExperienceList() 등 기존 코드 그대로 유지 ...

        // 페이지 처음 로드 시 리스트 렌더 (현재는 빈 배열 기준)
        document.addEventListener('DOMContentLoaded', function () {
        renderExperienceList();

        const profileFormEl = document.getElementById('profileForm');
        const experienceJsonField = document.getElementById('experienceJsonField');

        if (profileFormEl && experienceJsonField) {
        profileFormEl.addEventListener('submit', function () {
        // 폼 전송 직전에 experiences 배열을 JSON으로 직렬화해서 hidden 필드에 세팅
        const jsonString = JSON.stringify(experiences);
        experienceJsonField.value = jsonString;
    });
    }
    });


</script>
</body>
</html>
